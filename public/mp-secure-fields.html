<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GoDrive - Pagamento</title>

    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script src="https://www.mercadopago.com/v2/security.js" view="checkout"></script>

    <style>
      :root {
        --bg: #0b1220;
        --card: #111b2e;
        --muted: #a6b0c3;
        --text: #e8eefc;
        --primary: #3b82f6;
        --danger: #ef4444;
        --border: rgba(255, 255, 255, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        background: radial-gradient(1200px 600px at 20% 0%, #18284a 0%, var(--bg) 60%);
        color: var(--text);
        padding: 20px;
      }

      .container {
        max-width: 520px;
        margin: 0 auto;
      }

      .header {
        margin-bottom: 12px;
      }

      .title {
        font-size: 18px;
        font-weight: 650;
        margin: 0 0 6px;
      }

      .subtitle {
        color: var(--muted);
        margin: 0;
        font-size: 13px;
      }

      .card {
        background: rgba(17, 27, 46, 0.85);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        backdrop-filter: blur(8px);
      }

      .row {
        display: flex;
        gap: 12px;
      }

      .row > * {
        flex: 1;
      }

      label {
        display: block;
        color: var(--muted);
        font-size: 12px;
        margin: 10px 0 6px;
      }

      input,
      select {
        width: 100%;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.12);
        color: var(--text);
        padding: 12px 12px;
        outline: none;
      }

      input::placeholder {
        color: rgba(230, 237, 252, 0.5);
      }

      .secure-field {
        min-height: 44px;
        display: flex;
        align-items: center;
        padding: 0;
      }

      .secure-field > div {
        width: 100%;
        padding: 12px 12px;
      }

      .meta {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.4;
      }

      .actions {
        margin-top: 14px;
        display: flex;
        gap: 12px;
      }

      button {
        width: 100%;
        border: 0;
        border-radius: 12px;
        padding: 12px 12px;
        font-weight: 650;
        cursor: pointer;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.12);
        color: white;
      }

      .error {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(239, 68, 68, 0.35);
        background: rgba(239, 68, 68, 0.12);
        color: #fecaca;
        font-size: 12px;
        display: none;
        white-space: pre-wrap;
      }

      .loading {
        opacity: 0.7;
        pointer-events: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1 class="title">Pagamento com cartão</h1>
        <p class="subtitle">Dados do cartão são inseridos em campos seguros (PCI).</p>
      </div>

      <div class="card" id="card">
        <div>
          <label>Número do cartão</label>
          <div id="cardNumber" class="secure-field"></div>

          <div class="row">
            <div>
              <label>Mês</label>
              <div id="expirationMonth" class="secure-field"></div>
            </div>
            <div>
              <label>Ano</label>
              <div id="expirationYear" class="secure-field"></div>
            </div>
            <div>
              <label>CVV</label>
              <div id="securityCode" class="secure-field"></div>
            </div>
          </div>

          <label>Nome do titular</label>
          <input id="cardholderName" placeholder="Como no cartão" autocomplete="cc-name" />

          <div class="row">
            <div>
              <label>Documento</label>
              <select id="identificationType"></select>
            </div>
            <div>
              <label>Número</label>
              <input id="identificationNumber" placeholder="CPF" inputmode="numeric" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Banco emissor</label>
              <select id="issuer" disabled>
                <option value="">Selecione</option>
              </select>
            </div>
            <div>
              <label>Parcelas</label>
              <select id="installments" disabled>
                <option value="">Selecione</option>
              </select>
            </div>
          </div>

          <div class="meta" id="meta"></div>

          <div class="actions">
            <button class="btn-secondary" type="button" id="btnCancel">Cancelar</button>
            <button class="btn-primary" type="button" id="btnPay">Continuar</button>
          </div>

          <div class="error" id="error"></div>
        </div>
      </div>
    </div>

    <script>
      const ui = {
        card: document.getElementById('card'),
        error: document.getElementById('error'),
        meta: document.getElementById('meta'),
        cardholderName: document.getElementById('cardholderName'),
        identificationType: document.getElementById('identificationType'),
        identificationNumber: document.getElementById('identificationNumber'),
        issuer: document.getElementById('issuer'),
        installments: document.getElementById('installments'),
        btnPay: document.getElementById('btnPay'),
        btnCancel: document.getElementById('btnCancel'),
      };

      const state = {
        publicKey: null,
        isSandbox: null,
        mp: null,
        fields: null,
        amount: null,
        bin: null,
        paymentMethodId: null,
        issuerId: null,
        installments: null,
        deviceId: null,
      };

      function postMessage(payload) {
        try {
          if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
            window.ReactNativeWebView.postMessage(JSON.stringify(payload));
          }
        } catch (e) {}
      }

      function setError(msg) {
        ui.error.style.display = msg ? 'block' : 'none';
        ui.error.textContent = msg || '';
      }

      function setLoading(isLoading) {
        ui.card.classList.toggle('loading', Boolean(isLoading));
        ui.btnPay.disabled = Boolean(isLoading);
        ui.btnCancel.disabled = Boolean(isLoading);
      }

      function readQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const amount = params.get('amount');
        state.amount = amount ? String(amount) : null;
      }

      function updateMeta() {
        const parts = [];
        if (state.amount) parts.push(`Valor: R$ ${state.amount}`);
        if (state.paymentMethodId) parts.push(`Bandeira: ${state.paymentMethodId}`);
        if (state.bin) parts.push(`BIN: ${state.bin}`);
        if (state.deviceId) parts.push(`Device ID: ${state.deviceId}`);
        ui.meta.textContent = parts.join('  •  ');
      }

      function getDeviceId() {
        const id = window.MP_DEVICE_SESSION_ID;
        if (id && typeof id === 'string') {
          state.deviceId = id;
          updateMeta();
          postMessage({ type: 'MP_DEVICE_ID', deviceId: id });
          return true;
        }
        return false;
      }

      async function loadMpConfig() {
        const res = await fetch('/payments/mercado-pago/config');
        if (!res.ok) {
          throw new Error('Falha ao obter configuração do Mercado Pago');
        }
        const cfg = await res.json();
        if (!cfg?.publicKey) {
          throw new Error('MP publicKey não configurada no backend');
        }
        state.publicKey = cfg.publicKey;
        state.isSandbox = cfg.isSandbox;
      }

      async function initIdentificationTypes() {
        const types = await state.mp.getIdentificationTypes();
        ui.identificationType.innerHTML = '';
        for (const t of types || []) {
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = t.name;
          ui.identificationType.appendChild(opt);
        }

        const cpf = Array.from(ui.identificationType.options).find((o) => o.value === 'CPF');
        if (cpf) ui.identificationType.value = 'CPF';
      }

      function resetIssuerAndInstallments() {
        ui.issuer.innerHTML = '<option value="">Selecione</option>';
        ui.installments.innerHTML = '<option value="">Selecione</option>';
        ui.issuer.disabled = true;
        ui.installments.disabled = true;
        state.issuerId = null;
        state.installments = null;
      }

      async function refreshIssuerAndInstallments() {
        if (!state.bin || !state.paymentMethodId || !state.amount) {
          return;
        }

        resetIssuerAndInstallments();

        const [issuers, installments] = await Promise.all([
          state.mp.getIssuers({ paymentMethodId: state.paymentMethodId, bin: state.bin }),
          state.mp.getInstallments({ amount: String(state.amount), bin: state.bin, locale: 'pt-BR' }),
        ]);

        if (Array.isArray(issuers) && issuers.length > 0) {
          for (const issuer of issuers) {
            const opt = document.createElement('option');
            opt.value = String(issuer.id);
            opt.textContent = issuer.name;
            ui.issuer.appendChild(opt);
          }
          ui.issuer.disabled = false;
        }

        const payerCosts = Array.isArray(installments) && installments[0]?.payer_costs ? installments[0].payer_costs : [];
        if (Array.isArray(payerCosts) && payerCosts.length > 0) {
          for (const pc of payerCosts) {
            const opt = document.createElement('option');
            opt.value = String(pc.installments);
            opt.textContent = pc.recommended_message || `${pc.installments}x`;
            ui.installments.appendChild(opt);
          }
          ui.installments.disabled = false;
        }
      }

      function setupSelectListeners() {
        ui.issuer.addEventListener('change', () => {
          state.issuerId = ui.issuer.value ? String(ui.issuer.value) : null;
        });

        ui.installments.addEventListener('change', () => {
          state.installments = ui.installments.value ? Number(ui.installments.value) : null;
        });

        ui.btnCancel.addEventListener('click', () => {
          postMessage({ type: 'MP_CANCEL' });
        });

        ui.btnPay.addEventListener('click', async () => {
          setError('');
          setLoading(true);

          try {
            if (!state.mp) throw new Error('SDK não inicializado');

            const cardholderName = String(ui.cardholderName.value || '').trim();
            const identificationType = String(ui.identificationType.value || '').trim();
            const identificationNumber = String(ui.identificationNumber.value || '').trim();

            if (!cardholderName) throw new Error('Informe o nome do titular');
            if (!identificationType) throw new Error('Informe o tipo de documento');
            if (!identificationNumber) throw new Error('Informe o número do documento');

            if (!state.paymentMethodId) {
              throw new Error('Bandeira não identificada. Verifique o número do cartão.');
            }

            if (!state.issuerId) {
              throw new Error('Selecione o banco emissor');
            }

            if (!state.installments) {
              throw new Error('Selecione as parcelas');
            }

            const token = await state.mp.fields.createCardToken({
              cardholderName,
              identificationType,
              identificationNumber,
            });

            if (!token?.id) {
              throw new Error('Não foi possível gerar o token do cartão');
            }

            getDeviceId();

            postMessage({
              type: 'MP_TOKEN',
              token: token.id,
              paymentMethodId: state.paymentMethodId,
              issuerId: state.issuerId,
              installments: state.installments,
              deviceId: state.deviceId || null,
            });
          } catch (err) {
            const msg = err?.message || String(err);
            setError(msg);
            postMessage({ type: 'MP_ERROR', message: msg });
          } finally {
            setLoading(false);
          }
        });
      }

      async function initSecureFields() {
        const cardNumberField = state.mp.fields.create('cardNumber', { placeholder: 'Número do cartão' });
        const expirationMonthField = state.mp.fields.create('expirationMonth', { placeholder: 'MM' });
        const expirationYearField = state.mp.fields.create('expirationYear', { placeholder: 'AA' });
        const securityCodeField = state.mp.fields.create('securityCode', { placeholder: 'CVV' });

        cardNumberField.mount('cardNumber');
        expirationMonthField.mount('expirationMonth');
        expirationYearField.mount('expirationYear');
        securityCodeField.mount('securityCode');

        cardNumberField.on('binChange', async (e) => {
          try {
            setError('');

            const bin = e?.bin ? String(e.bin) : null;
            if (!bin) {
              state.bin = null;
              state.paymentMethodId = null;
              resetIssuerAndInstallments();
              updateMeta();
              return;
            }

            state.bin = bin;
            updateMeta();

            const methods = await state.mp.getPaymentMethods({ bin });
            const methodId = methods?.results?.[0]?.id ? String(methods.results[0].id) : null;
            state.paymentMethodId = methodId;
            updateMeta();

            if (!methodId) {
              resetIssuerAndInstallments();
              return;
            }

            await refreshIssuerAndInstallments();
          } catch (err) {
            const msg = err?.message || String(err);
            setError(msg);
          }
        });

        for (const f of [cardNumberField, expirationMonthField, expirationYearField, securityCodeField]) {
          f.on('error', (e) => {
            if (e?.errorMessages?.length) {
              const msg = e.errorMessages.map((m) => m.message).filter(Boolean).join('\n');
              setError(msg || 'Campo inválido');
            }
          });
        }
      }

      async function bootstrap() {
        readQueryParams();
        setupSelectListeners();

        setLoading(true);
        try {
          await loadMpConfig();
          state.mp = new MercadoPago(state.publicKey, { locale: 'pt-BR', advancedFraudPrevention: true });

          await initIdentificationTypes();
          await initSecureFields();

          updateMeta();

          const maxTries = 25;
          let tries = 0;
          const timer = setInterval(() => {
            tries += 1;
            const ok = getDeviceId();
            if (ok || tries >= maxTries) {
              clearInterval(timer);
            }
          }, 200);

          postMessage({ type: 'MP_READY', isSandbox: state.isSandbox });
        } catch (err) {
          const msg = err?.message || String(err);
          setError(msg);
          postMessage({ type: 'MP_ERROR', message: msg });
        } finally {
          setLoading(false);
        }
      }

      bootstrap();
    </script>
  </body>
</html>
